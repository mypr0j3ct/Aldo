<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar</title>
    <script type="module" src="./config-sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            position: relative;
            overflow: hidden;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="20" cy="80" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
        }
        
        .signup-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px 35px;
            border-radius: 18px;
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            width: 100%;
            max-width: 400px;
            text-align: center;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .logo-container {
            margin-bottom: 25px;
        }
        
        .user-icon { 
            width: 56px;
            height: 56px;
            margin: 0 auto 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 18px rgba(102, 126, 234, 0.3);
        }
        
        .signup-container h2 {
            margin-bottom: 6px;
            color: #1a1a1a;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }
        
        .subtitle {
            color: #666;
            font-size: 13px;
            margin-bottom: 25px;
            font-weight: 400;
        }
        
        .input-group {
            position: relative;
            margin-bottom: 16px;
        }
        
        .input-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            z-index: 2;
        }
        
        input[type="email"], input[type="password"], input[type="text"] {
            width: 100%;
            padding: 14px 14px 14px 42px;
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            background: #fafafa;
            transition: all 0.3s ease;
            color: #1a1a1a;
        }
        
        input[type="email"]:focus, input[type="password"]:focus, input[type="text"]:focus {
            border-color: #667eea;
            background: #ffffff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        input::placeholder {
            color: #999;
            font-weight: 400;
        }
        
        .password-wrapper {
            position: relative;
        }
        
        .password-wrapper .toggle-password {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            transition: all 0.2s ease;
            z-index: 2;
        }
        
        .password-wrapper .toggle-password:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        button[type="submit"] {
            width: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            margin-top: 6px;
        }
        
        button[type="submit"]:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        button[type="submit"]:active {
            transform: translateY(0);
        }
        
        p {
            margin-top: 18px;
            font-size: 13px;
            color: #666;
        }
        
        a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
        }
        
        a:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px; 
            }
            .signup-container { 
                padding: 25px 20px; 
                margin: 5px;
                max-width: 95%;
            }
            
            .signup-container h2 { 
                font-size: 20px; 
            }

            .subtitle {
                font-size: 12px;    
                margin-bottom: 20px; 
            }

            .input-group {
                margin-bottom: 14px;
            }

            input[type="email"], input[type="password"], input[type="text"] {
                padding: 12px 12px 12px 38px; 
                font-size: 14px;             
            }

            .input-icon {
                left: 12px;
                width: 16px;
                height: 16px;
            }
            
            button[type="submit"] {
                padding: 12px;    
                font-size: 14px; 
            }

            p {
                font-size: 12px;    
                margin-top: 16px;   
            }
            
            .logo-container {
                margin-bottom: 20px;
            }

            .user-icon { 
                width: 48px;         
                height: 48px;        
                margin: 0 auto 10px; 
            }

            .user-icon svg { 
                width: 24px;         
                height: 24px;       
            }
        }

        @media (max-height: 700px) {
            .signup-container {
                padding: 20px 30px;
                max-height: 95vh;
            }
            
            .logo-container {
                margin-bottom: 20px;
            }
            
            .user-icon {
                width: 48px;
                height: 48px;
                margin: 0 auto 8px;
            }
            
            .signup-container h2 {
                font-size: 20px;
                margin-bottom: 4px;
            }
            
            .subtitle {
                font-size: 12px;
                margin-bottom: 20px;
            }
            
            .input-group {
                margin-bottom: 14px;
            }
            
            p {
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="signup-container">
        <div class="logo-container">
            <div class="user-icon"> <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7Z" fill="white"/>
                    <path d="M12 14C8.13401 14 5 17.134 5 21H19C19 17.134 15.866 14 12 14Z" fill="white"/>
                </svg>
            </div>
            <h2>Buat Akun Baru</h2>
            <p class="subtitle">Daftarkan diri Anda untuk memulai</p>
        </div>
        
        <form id="signupForm">
            <div class="input-group">
                <div class="input-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 12.75C13.63 12.75 15.07 13.14 16.24 13.65C17.32 14.13 18 15.21 18 16.38V17C18 17.55 17.55 18 17 18H7C6.45 18 6 17.55 6 17V16.39C6 15.21 6.68 14.13 7.76 13.66C8.93 13.14 10.37 12.75 12 12.75ZM12 6C13.66 6 15 7.34 15 9C15 10.66 13.66 12 12 12C10.34 12 9 10.66 9 9C9 7.34 10.34 6 12 6Z" fill="#999"/>
                    </svg>
                </div>
                <input type="text" id="username" placeholder="Nama Pengguna" required>
            </div>
            
            <div class="input-group">
                <div class="input-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 2C7.89543 2 7 2.89543 7 4V5H6C4.89543 5 4 5.89543 4 7V19C4 20.1046 4.89543 21 6 21H18C19.1046 21 20 20.1046 20 19V7C20 5.89543 19.1046 5 18 5H17V4C17 2.89543 16.1046 2 15 2H9ZM9 4H15V6H9V4ZM6 8V19H18V8H6Z" fill="#999"/>
                        <path d="M8 11H16V13H8V11Z" fill="#999"/>
                        <path d="M8 15H14V17H8V15Z" fill="#999"/>
                    </svg>
                </div>
                <input type="text" id="microcontroler" placeholder="ID Microcontroler (000-999)" required>
            </div>
            
            <div class="input-group">
                <div class="input-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 4H4C2.9 4 2.01 4.9 2.01 6L2 18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 8L12 13L4 8V6L12 11L20 6V8Z" fill="#999"/>
                    </svg>
                </div>
                <input type="email" id="email" placeholder="Alamat Email" required>
            </div>
            
            <div class="input-group">
                <div class="password-wrapper">
                    <div class="input-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C10.3431 2 9 3.34315 9 5V7H7C5.89543 7 5 7.89543 5 9V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V9C19 7.89543 18.1046 7 17 7H15V5C15 3.34315 13.6569 2 12 2ZM13 7V5C13 4.44772 12.5523 4 12 4C11.4477 4 11 4.44772 11 5V7H13Z" fill="#999"/>
                        </svg>
                    </div>
                    <input type="password" id="password" placeholder="Kata Sandi" required>
                    <div class="toggle-password" id="togglePassword1">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5S21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12S9.24 7 12 7S17 9.24 17 12S14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12S10.34 15 12 15S15 13.66 15 12S13.66 9 12 9Z" fill="#667eea"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <div class="password-wrapper">
                    <div class="input-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 8H17V6C17 3.24 14.76 1 12 1S7 3.24 7 6V8H6C4.9 8 4 8.9 4 10V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V10C20 8.9 19.1 8 18 8ZM9 6C9 4.34 10.34 3 12 3S15 4.34 15 6V8H9V6ZM18 20H6V10H18V20ZM12 17C13.1 17 14 16.1 14 15S13.1 13 12 13S10 13.9 10 15S10.9 17 12 17Z" fill="#999"/>
                        </svg>
                    </div>
                    <input type="password" id="confirm_password" placeholder="Konfirmasi Kata Sandi" required>
                    <div class="toggle-password" id="togglePassword2">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5S21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12S9.24 7 12 7S17 9.24 17 12S14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12S10.34 15 12 15S15 13.66 15 12S13.66 9 12 9Z" fill="#667eea"/>
                        </svg>
                    </div>
                </div>
            </div>
            <button type="submit">Daftar Akun</button>
        </form>
        <p>Sudah punya akun? <a href="masuk.html">Masuk sekarang</a></p> </div>
    </div>

    <script type="module">
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
        import { app } from "./config-sdk.js";
        const db = getDatabase(app);
        const signupForm = document.getElementById('signupForm');
        
        function validateAndFormatIdMicro(idmicro) {
            if (!/^\d+$/.test(idmicro)) {
                return { valid: false, message: 'ID Microcontroler harus berupa angka.' };
            }
            const idNumber = parseInt(idmicro, 10);
            if (idNumber < 0 || idNumber > 999) {
                return { valid: false, message: 'ID Microcontroler harus antara 000 sampai 999.' };
            }
            const formattedId = idNumber.toString().padStart(3, '0');
            return { valid: true, formattedId: formattedId };
        }
        
        async function isIdMicroRegistered(idmicro) {
            const usersRef = ref(db, 'users');
            try {
                const snapshot = await get(usersRef);
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    for (const userKey in users) {
                        if (users[userKey].idmicro === idmicro) {
                            return true;
                        }
                    }
                }
                return false;
            } catch (error) {
                console.error("Error saat memeriksa ID Microcontroler:", error);
                throw error; 
            }
        }
        
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const rawIdMicro = document.getElementById('microcontroler').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (password !== confirmPassword) {
                alert('Password dan Konfirmasi Password tidak sama.');
                return;
            }
            
            const idMicroResult = validateAndFormatIdMicro(rawIdMicro);
            if (!idMicroResult.valid) {
                alert(idMicroResult.message);
                return;
            }
            
            const formattedIdMicro = idMicroResult.formattedId;
            
            try {
                const idMicroExists = await isIdMicroRegistered(formattedIdMicro);
                if (idMicroExists) {
                    alert('ID Microcontroler sudah terdaftar. Silakan gunakan ID lain.');
                    return;
                }
                
                const emailKey = email.replace(/[.#$[\]]/g, '_');
                const userRef = ref(db, `users/${emailKey}`);
                const emailSnapshot = await get(userRef);
                
                if (emailSnapshot.exists()) {
                    alert('Email sudah terdaftar. Silakan gunakan email lain.');
                    return;
                }
                
                await set(userRef, { 
                    username: username, 
                    idmicro: formattedIdMicro, 
                    email: email, 
                    password: password 
                });
                
                window.location.href = 'masuk.html'; 
            } catch (error) {
                console.error("Terjadi kesalahan saat pendaftaran:", error);
                alert("Terjadi kesalahan saat mendaftar. Silakan coba lagi.");
            }
        });

        const togglePassword1 = document.getElementById('togglePassword1');
        const togglePassword2 = document.getElementById('togglePassword2');
        const passwordInput1 = document.getElementById('password'); 
        const passwordInput2 = document.getElementById('confirm_password'); 
        
        function setupToggle(toggleElement, passwordElement) {
            toggleElement.addEventListener('click', () => {
                const isPassword = passwordElement.type === 'password';
                passwordElement.type = isPassword ? 'text' : 'password';
                
                toggleElement.innerHTML = isPassword ? 
                    `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 7C9.24 7 7 9.24 7 12S9.24 17 12 17S17 14.76 17 12S14.76 7 12 7ZM12 15C10.34 15 9 13.66 9 12S10.34 9 12 9S15 10.34 15 12S13.66 15 12 15Z" fill="#667eea"/>
                        <path d="M1 12C2.73 7.61 7 4.5 12 4.5S21.27 7.61 23 12L20.05 12.74L17.31 10L12 4.5L6.69 10L3.95 12.74L1 12Z" fill="#667eea"/>
                        <path d="M3 3L21 21L19.59 22.41L17.17 20L15.59 18.41C14.5 18.78 13.28 19 12 19.5C7 19.5 2.73 16.39 1 12C1.13 11.7 1.26 11.4 1.41 11.11L3 3Z" fill="#667eea"/>
                    </svg>` :
                    `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5S21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12S9.24 7 12 7S17 9.24 17 12S14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12S10.34 15 12 15S15 13.66 15 12S13.66 9 12 9Z" fill="#667eea"/>
                    </svg>`;
            });
        }

        setupToggle(togglePassword1, passwordInput1);
        setupToggle(togglePassword2, passwordInput2);
    </script>
</body>
</html>
